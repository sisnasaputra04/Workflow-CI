name: MLflow-CI-Advanced

# =========================
# Trigger workflow
# =========================
on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  mlflow-ci:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # 1. Set up job
      # =========================
      - name: Set up job
        run: echo "Starting MLflow CI pipeline"

      # =========================
      # 2. Checkout repository
      # =========================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================
      # 3. Set up Python environment
      # =========================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # =========================
      # 4. Check environment
      # =========================
      - name: Check environment
        run: |
          python --version
          pip --version

      # =========================
      # 5. Install dependencies
      # =========================
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install mlflow pandas scikit-learn

      # =========================
      # 6. Run MLflow Project
      # =========================
      - name: Run MLflow Project
        run: |
          cd MLProject
          mlflow run .

      # =========================
      # 7. Get latest MLflow run_id
      # =========================
      - name: Get latest MLflow run_id
        run: |
          cd MLProject
          echo "MLflow run_id:"
          cat run_id.txt

      # =================================================
      # =============== SKILLED LEVEL ===================
      # =================================================

      # =========================
      # 8. Prepare MLflow artifacts
      # =========================
      - name: Prepare MLflow artifacts
        run: |
          mkdir -p artifacts
          zip -r artifacts/mlflow_artifacts.zip MLProject/mlruns

      # =========================
      # 9. Upload MLflow artifacts
      # =========================
      - name: Upload MLflow Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-artifacts
          path: artifacts/mlflow_artifacts.zip

      # =================================================
      # =============== ADVANCED LEVEL ==================
      # =================================================

      # =========================
      # 10. Build Docker image from MLflow model
      # =========================
      - name: Build Docker Model
        run: |
          cd MLProject
          mlflow models build-docker \
            -m runs:/$(cat run_id.txt)/model \
            -n ${{ secrets.DOCKER_USERNAME }}/telco-churn-mlflow

      # =========================
      # 11. Login to Docker Hub
      # =========================
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # =========================
      # 12. Push Docker image
      # =========================
      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/telco-churn-mlflow

      # =========================
      # 13. Complete job
      # =========================
      - name: Complete job
        run: echo "MLflow CI Advanced pipeline completed successfully"
